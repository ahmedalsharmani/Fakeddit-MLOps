name: MLOps Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  train-and-track:
    runs-on: ubuntu-latest

    steps:
      - name:  Set up job
        run: echo " Starting MLOps training pipeline..."

      - name:  Checkout repository
        uses: actions/checkout@v3

      - name:  Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name:  Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install dvc mlflow tensorflow keras scikit-learn pandas numpy matplotlib

      - name:  Verify DVC setup
        run: |
          dvc version
          echo " DVC setup verified successfully!"

      - name:  Skip DVC dataset pull
        run: echo " Skipping DVC pull — using Git LFS dataset files instead."

      - name:  Add src to PYTHONPATH
        run: |
          echo "PYTHONPATH=$PYTHONPATH:$(pwd)/src" >> $GITHUB_ENV
          echo " Added src directory to PYTHONPATH"

      - name:  Run model training
        run: |
          echo " Starting model training..."
          python src/train.py
        env:
          MLFLOW_TRACKING_URI: file:./mlruns

      - name:  Save MLflow artifacts
        if: success()
        uses: actions/upload-artifact@v3
        with:
          name: mlflow-artifacts
          path: mlruns/

      - name:  Post Set up Python
        run: echo " Cleaning up Python environment..."

      - name: ✅ Post Checkout repository
        run: echo "✅ CI/CD pipeline finished successfully!"
